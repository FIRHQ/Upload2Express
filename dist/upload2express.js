!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.Upload2Express=t():e.Upload2Express=t()}(this,(function(){return(()=>{"use strict";var e={d:(t,n)=>{for(var i in n)e.o(n,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:n[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{UploadHelper:()=>i,buildImageUrl:()=>d,buildQrUrl:()=>r,buildUploadPageUrl:()=>o,fetchImageUrlInfo:()=>s});const n=(e,t)=>{e&&(e.style.display=t?"":"none")},i=class{constructor({uploadPanel:e,projectId:t,domain:n="uploadhelper.ce04.com",imgElement:i=null,qrImgElement:l=null,qrcodeWidth:o=200,imgMaxWidth:d=200,imgMaxHeight:r=200}){this.uploadPanel=e,this.projectId=t,this.domain=n,this.imgElement=i||panel.querySelector(".img"),null==this.imgElement&&(this.imgElement=document.createElement("img"),this.imgElement.className="img",this.imgElement.style.cssText=`max-width: ${d}px;max-height: ${r};display:none`,this.uploadPanel.appendChild(this.imgElement)),this.qrImgElement=l||panel.querySelector(".qrcodeImg"),null==this.qrImgElement&&(this.qrImgElement=document.createElement("img"),this.qrImgElement.className="qrcodeImg",this.qrImgElement.style.cssText=`width: ${o}px;height: ${o}px;display:none`,this.uploadPanel.appendChild(this.qrImgElement))}bindAllElement({qrcodeBtn:e,linkBtn:t,userId:i,uid:l,fetchSecretPromise:d=null,mainAttribute:s=null,secondAttribute:u=null,updateFunction:m=(e=>{console.log(`img updated: ${e}`)})}){let a=d;null==a&&(a=Promise.resolve(null)),a.then((d=>{e&&(e.onclick=e=>{e.preventDefault(),n(this.qrImgElement,!0),this.qrImgElement.src=r(this.projectId,i,l,s,u,d,this.domain),this.bindImgLoad({userId:i,uid:l,updateFunction:m})}),t&&(t.onclick=e=>{n(this.qrImgElement,!1),this.bindImgLoad({userId:i,uid:l,updateFunction:m});let t=o(this.projectId,i,l,s,u,d,this.domain);window.open(t)})}))}bindImgLoad({userId:e,uid:t,updateFunction:i}){let l=d(this.projectId,e,t,this.domain);((e,t,i=(e=>{}))=>{e.src=t,e.onerror=()=>{n(e,!1),setTimeout((()=>{e.src=`${t}&t=${(new Date).getTime()}`}),3e3)},e.onload=()=>{n(e,!0),i(t)}})(this.imgElement,l,(e=>{n(this.qrImgElement,!1),i(e)}))}uploadByBrowser({userId:e=-1,uid:t,secret:i=null,mainAttribute:l=null,secondAttribute:d=null,updateFunction:r}){n(this.qrImgElement,!1),this.bindImgLoad({userId:e,uid:t,updateFunction:r});let s=o(this.projectId,e,t,l,d,i,this.domain);window.open(s)}uploadByQrScan({userId:e=-1,uid:t,secret:i=null,mainAttribute:l=null,secondAttribute:o=null,updateFunction:d}){n(this.qrImgElement,!0),this.qrImgElement.src=r(this.projectId,e,t,l,o,i,this.domain),this.bindImgLoad({userId:e,uid:t,updateFunction:d})}};let l;const o=(e,t,n,i=null,l=null,o=null,d="https://uploadhelper.ce04.com")=>{var r=`${d}/projects/${e}/standard_images/new?client_user_uid=${t}&upload_uid=${n}&main_attribute=${i}&second_attribute=${l}`;return o&&(r=`${r}&secret=${o}`),r},d=(e,t,n,i="https://uploadhelper.ce04.com")=>`${i}/fetch_image?project_id=${e}&client_user_id=${t}&upload_uid=${n}`,r=(e,t,n,i=null,l=null,d=null,r="https://uploadhelper.ce04.com")=>`${r}/welcome/qrcode?url=${encodeURIComponent(o(e,t,n,i,l,d,r))}`,s=(e,t,n,i="https://uploadhelper.ce04.com")=>new Promise((function(o,d){fetch(`${i}/projects/${e}/standard_images/fetch_status`,{method:"POST",type:"cors",headers:{"user-agent":"check v1","content-type":"application/json"},body:JSON.stringify({client_user_id:t,upload_uid:n})}).then((d=>{200!=d.status?(clearTimeout(l),l=setTimeout((()=>{console.log(l),s(e,t,n,i).then((e=>{o(e)}))}),5e3)):d.json().then((e=>o(e)))}))}));return t})()}));